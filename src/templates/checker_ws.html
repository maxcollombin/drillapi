<!DOCTYPE html>
<html>
<head>
  <title>Service Availability Checker</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    pre { white-space: pre-wrap; }
    .error-box {
      width: 80vw;
      margin: 10px auto;
      background: #f8d7da;
      padding: 10px;
      overflow-x: auto;
      font-size: 0.9em;
      border: 1px solid #f5c6cb;
    }
    .success-box {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      width: 80vw;
      margin: 10px auto;
      padding: 10px;
      overflow-x: auto;
      font-size: 0.9em;
    }
    summary { cursor: pointer; font-weight: bold; }
    h2, h3 { margin-top: 20px; }
    a.full-url {
      color: #0056b3;
      text-decoration: none;
    }
    a.full-url:hover { text-decoration: underline; }
  </style>
</head>

<body>
  <h2>Service Availability Checker</h2>
  <p>For single canton check, add path parameter containing  canton's code. For instance /checker/ZG</p>
  <div id="results"></div>

  <script>
    const resultsDiv = document.getElementById("results");

    // canton value sent from backend
    const canton = "{{ canton | default('') }}";

    // Build WebSocket URL‚Äîalways use ws:// or wss:// depending on site
    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") +
                  location.host + "/checker/ws";

    console.log("üîå Connecting to WebSocket:", wsUrl);

    const socket = new WebSocket(wsUrl);

    socket.onopen = () => {
      // Send chosen canton to backend
      socket.send(JSON.stringify({ canton }));
      console.log("üì§ Sent canton filter:", canton);
    };

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      console.log("üì® Received:", data);

      if (data.event === "end") {
        const done = document.createElement("h3");
        done.textContent = "‚úÖ All checks completed.";
        resultsDiv.appendChild(done);
        return;
      }

      if (data.error) {
        const errBox = document.createElement("div");
        errBox.classList.add("error-box");
        errBox.innerHTML = `<strong>Error:</strong> ${data.error}`;
        resultsDiv.appendChild(errBox);
        return;
      }

      // Group by canton
      let cantonDiv = document.getElementById(`canton-${data.canton}`);
      if (!cantonDiv) {
        cantonDiv = document.createElement("div");
        cantonDiv.id = `canton-${data.canton}`;
        cantonDiv.innerHTML = `<h3>Checking service for ${data.canton}</h3>`;
        resultsDiv.appendChild(cantonDiv);
      }

      const details = document.createElement("details");

      // Consider it an error if success is false OR control_harmonized_values is "error"
      const isError = !data.success || data.control_harmonized_values === "error";

      details.classList.add(isError ? "error-box" : "success-box");

      const summaryText = isError
        ? `‚ùå Request/Error for ${data.url}`
        : `‚úÖ Success (HTTP ${data.status}) - ${data.url}`;

      let fullUrlLink = "";
      try {
        const fullUrl = data?.content?.result_detail?.full_url;
        if (fullUrl) {
          fullUrlLink = `
            <p><strong>Full request URL:</strong>
            <a class="full-url" href="${fullUrl}" target="_blank" rel="noopener noreferrer">
              ${fullUrl}
            </a></p>`;
        }
      } catch (e) {}

      details.innerHTML = `
        <summary>${summaryText}</summary>
        ${fullUrlLink}<br>
        <b>${data.control_harmonized_values_message}</b>
        <pre>${JSON.stringify(data.content || data.error || "", null, 2)}</pre>
      `;

      cantonDiv.appendChild(details);

    };

    socket.onerror = (event) => {
      console.error("üî• WebSocket error", event);
    };

    socket.onclose = () => {
      console.log("üîå WebSocket closed");
    };
  </script>
</body>
</html>
